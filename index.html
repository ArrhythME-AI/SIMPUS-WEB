<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMPUS MKP KELOMPOK 10</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Variabel CSS */
        :root {
            --primary-dark: #294060;
            --primary-light: #00BCD4;
            --accent-green: #4CAF50;
            --bg-light: #a8d0ea;
            --card-bg: #FFFFFF;
            --text-color: #333333;
            --border-color: #DDDDDD;
            --shadow-light: rgba(0,0,0,0.08);
            --shadow-medium: rgba(0,0,0,0.15);
        }

        /* Styling Umum */
        body {
            font-family: 'Lato', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-light);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 20px auto;
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 12px var(--shadow-light);
        }

        h1, h2, h3 {
            font-family: 'Poppins', sans-serif;
            color: var(--primary-dark);
            margin-top: 0;
            margin-bottom: 20px;
        }
        h1 {
            text-align: center;
            font-size: 2.5em;
            color: var(--primary-dark);
            margin-bottom: 30px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
        }

        /* Navigasi */
        nav ul {
            list-style: none;
            padding: 0;
            display: flex;
            justify-content: center;
            background-color: var(--primary-dark);
            padding: 15px 0;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 4px 8px var(--shadow-light);
            flex-wrap: wrap;
        }
        nav ul li {
            margin: 0 15px;
        }
        nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            font-size: 1.1em;
            padding: 8px 12px;
            transition: background-color 0.3s ease, border-radius 0.3s ease;
        }
        nav ul li a:hover {
            background-color: var(--primary-light);
            border-radius: 5px;
        }
        nav ul li a.active {
            background-color: var(--primary-light);
            border-radius: 5px;
        }

        /* Bagian Section */
        .section {
            padding: 25px;
            margin-bottom: 25px;
            border-radius: 8px;
            background-color: var(--card-bg);
            box-shadow: 0 2px 5px var(--shadow-light);
            transition: transform 0.2s ease;
        }
        .section:hover {
            transform: translateY(-3px);
        }

        /* Dashboard Widgets (Cards) */
        .widget-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .widget {
            background-color: #E6F7FF;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 4px var(--shadow-light);
            border-left: 5px solid var(--primary-light);
            transition: all 0.3s ease;
        }
        .widget:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px var(--shadow-medium);
        }
        .widget h3 {
            color: var(--primary-dark);
            font-size: 1.3em;
            margin-bottom: 10px;
        }
        .widget p {
            font-size: 2.8em;
            font-weight: 700;
            color: var(--primary-light);
            margin: 0;
        }

        /* Form Styling */
        form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-dark);
        }
        form input[type="text"],
        form input[type="date"],
        form select,
        form textarea {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1em;
            box-sizing: border-box;
        }
        form input[type="text"]:focus,
        form select:focus,
        form textarea:focus {
            border-color: var(--primary-light);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.2);
        }
        form button[type="submit"] {
            background-color: var(--accent-green);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        form button[type="submit"]:hover {
            background-color: #43A047;
            transform: translateY(-1px);
        }
        form button[type="submit"]:active {
            transform: translateY(0);
        }

        /* Tabel Styling */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px var(--shadow-light);
        }
        table thead {
            background-color: var(--primary-dark);
            color: white;
        }
        table th,
        table td {
            border: 1px solid var(--border-color);
            padding: 12px 15px;
            text-align: left;
        }
        table th:first-child { border-top-left-radius: 8px; }
        table th:last-child { border-top-right-radius: 8px; }
        table tr:last-child td:first-child { border-bottom-left-radius: 8px; }
        table tr:last-child td:last-child { border-bottom-right-radius: 8px; }

        table tbody tr:nth-child(even) {
            background-color: #F8F8F8;
        }
        table tbody tr:hover {
            background-color: #E0F7FA;
            cursor: pointer;
        }

        /* Login Modal */
        #loginModal {
            display: flex; /* Default to flex so it's shown initially */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #loginModal > div {
            background: rgb(109, 176, 195); /* Adjusted background color for visual distinction */
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 8px 16px var(--shadow-medium);
            text-align: center;
            width: 300px;
            animation: fadeInScale 0.4s ease-out;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        #loginModal h2 {
            margin-bottom: 25px;
            color: var(--primary-dark);
        }
        #loginModal input[type="text"],
        #loginModal input[type="password"] {
            width: calc(100% - 22px);
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1em;
            box-sizing: border-box;
        }
        #loginModal input[type="text"]:focus,
        #loginModal input[type="password"]:focus {
            border-color: var(--primary-light);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.2);
        }

        #loginModal button {
            background-color: var(--primary-light);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 0 10px;
            font-size: 1em;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        #loginModal button:hover {
            background-color: #008C9D;
            transform: translateY(-1px);
        }
        #loginModal button:active {
            transform: translateY(0);
        }
        #loginModal button:last-child {
            background-color: #95A5A6;
        }
        #loginModal button:last-child:hover {
            background-color: #7F8C8D;
        }

        .demo-info {
            background-color: #F0F8FF;
            border: 1px solid #ADD8E6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            text-align: left;
            font-size: 0.9em;
            color: #555;
            line-height: 1.4;
        }
        .demo-info strong {
            color: var(--primary-dark);
        }
        .demo-info p {
            margin: 5px 0;
        }


        /* Responsiveness Sederhana */
        @media (max-width: 768px) {
            .container {
                margin: 10px auto;
                padding: 20px;
            }
            nav ul {
                flex-direction: column;
                align-items: center;
            }
            nav ul li {
                margin: 5px 0;
            }
            .widget-grid {
                grid-template-columns: 1fr;
            }
            #loginModal > div {
                width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="mainContent" style="display: none;">
            <h1>SIMPUS MKP KELOMPOK 10</h1>

            <nav>
                <ul>
                    <li><a href="#dashboard" class="active">Dashboard</a></li>
                    <li><a href="#pendaftaran">Pendaftaran</a></li>
                    <li><a href="#rekam-medis">Rekam Medis</a></li>
                    <li><a href="#rawat-inap">Rawat Inap</a></li>
                    <li><a href="#farmasi">Farmasi</a></li>
                    <li><a href="#laporan">Laporan</a></li>
                    <li><a href="#" id="authLink" onclick="showLogin()">Login/Logout</a></li>
                </ul>
            </nav>

            <div id="dashboard" class="section">
                <h2>Dashboard</h2>
                <p>Selamat datang di SIMPUS Anda.</p>
                <div style="text-align: center; margin-bottom: 20px;">
                    <img src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExNGQ0ODk4Y2VmcGNwZm54bDBuM3B3eG5vcWV3azI5NHh5NDV4NnU2YSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/2w0D1F3gG069Nn05g2/giphy.gif" alt="Selamat Datang di SIMPUS" style="max-width: 300px; height: auto; border-radius: 8px;">
                    <p style="font-size: 0.9em; color: #666; margin-top: 5px;">Aplikasi Sistem Informasi Puskesmas</p>
                </div>
                <h3>Ringkasan Data Puskesmas</h3>
                <div class="widget-grid">
                    <div class="widget">
                        <h3>Total Pasien</h3>
                        <p id="totalPasien">0</p>
                    </div>
                    <div class="widget">
                        <h3>Kunjungan Hari Ini</h3>
                        <p id="kunjunganHariIni">0</p>
                    </div>
                    <div class="widget">
                        <h3>Pasien Rawat Inap</h3>
                        <p id="pasienRawatInap">0</p>
                    </div>
                    <div class="widget">
                        <h3>Pasien Rujukan</h3>
                        <p id="pasienRujukan">0</p>
                    </div>
                </div>
                
                <h3>Pasien Terbaru</h3>
                <table id="tabelPasien">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nama</th>
                            <th>Jenis Kunjungan</th>
                            <th>Tanggal</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>

            <div id="pendaftaran" class="section" style="display: none;">
                <h2>Pendaftaran Pasien Baru</h2>
                <form id="formPendaftaran">
                    <label for="namaPasien">Nama Pasien:</label>
                    <input type="text" id="namaPasien" name="namaPasien" required>

                    <label for="tanggalLahir">Tanggal Lahir:</label>
                    <input type="date" id="tanggalLahir" name="tanggalLahir">

                    <label for="alamatPasien">Alamat:</label>
                    <textarea id="alamatPasien" name="alamatPasien" rows="3"></textarea>

                    <label for="jenisKunjungan">Jenis Kunjungan:</label>
                    <select id="jenisKunjungan" name="jenisKunjungan">
                        <option value="rawat_jalan">Rawat Jalan</option>
                        <option value="rawat_inap">Rawat Inap</option>
                        <option value="rujukan">Rujukan</option>
                    </select>

                    <label for="statusRujukan" style="margin-top: 15px;">Status Rujukan:</label>
                    <select id="statusRujukan" name="statusRujukan">
                        <option value="tidak">Tidak Dirujuk</option>
                        <option value="dirujuk">Dirujuk</option>
                    </select>
                    
                    <div id="rujukanDetailFields" style="display: none;">
                        <label for="alasanRujukan" style="margin-top: 15px;">Alasan Rujukan:</label>
                        <textarea id="alasanRujukan" name="alasanRujukan" rows="2"></textarea>

                        <label for="fasilitasRujukan">Fasilitas Rujukan:</label>
                        <input type="text" id="fasilitasRujukan" name="fasilitasRujukan">
                    </div>

                    <button type="submit" style="margin-top: 20px;">Daftar Pasien</button>
                </form>

                <h3>Daftar Pasien Terdaftar</h3>
                <table id="tabelPendaftaranPasien">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nama</th>
                            <th>Jenis Kunjungan</th>
                            <th>Tanggal</th>
                            <th>Status Rujukan</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>

            <div id="rekam-medis" class="section" style="display: none;">
                <h2>Rekam Medis Pasien</h2>
                <p>Kelola riwayat kesehatan, diagnosa, dan tindakan medis.</p>
                <h3>Daftar Pasien Rawat Jalan</h3>
                <table id="tabelRekamMedisRawatJalan">
                    <thead>
                        <tr>
                            <th>ID Pasien</th>
                            <th>Nama</th>
                            <th>Tanggal Kunjungan</th>
                            <th>Diagnosa (ICD-10)</th>
                            <th>Tindakan (ICD-9)</th>
                        </tr>
                    </thead>
                    <tbody id="rekamMedisRawatJalanBody">
                        </tbody>
                </table>
                <h3 style="margin-top: 30px;">Daftar Pasien Rujukan</h3>
                <table id="tabelRekamMedisRujukan">
                    <thead>
                        <tr>
                            <th>ID Pasien</th>
                            <th>Nama</th>
                            <th>Tanggal Rujukan</th>
                            <th>Alasan Rujukan</th>
                            <th>Fasilitas Rujukan</th>
                        </tr>
                    </thead>
                    <tbody id="rekamMedisRujukanBody">
                        </tbody>
                </table>
            </div>

            <div id="rawat-inap" class="section" style="display: none;">
                <h2>Manajemen Rawat Inap</h2>
                <p>Kelola alokasi kamar, status pasien, dan catatan perkembangan.</p>
                <table>
                    <thead>
                        <tr>
                            <th>ID Pasien</th>
                            <th>Nama</th>
                            <th>Ruangan</th>
                            <th>Bed</th>
                            <th>Tanggal Masuk</th>
                            <th>Diagnosa</th>
                        </tr>
                    </thead>
                    <tbody id="rawatInapBody">
                        </tbody>
                </table>
            </div>

            <div id="farmasi" class="section" style="display: none;">
                <h2>Manajemen Farmasi (Obat)</h2>
                <p>Kelola stok obat dan resep pasien.</p>
                <h3>Stok Obat</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Nama Obat</th>
                            <th>Stok</th>
                            <th>Satuan</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>Paracetamol 500mg</td><td>250</td><td>Tablet</td></tr>
                        <tr><td>Amoxicillin 250mg</td><td>180</td><td>Kapsul</td></tr>
                        <tr><td>Obat Batuk Sirup</td><td>50</td><td>Botol</td></tr>
                        <tr><td>Larutan Oralit</td><td>100</td><td>Sachet</td></tr>
                    </tbody>
                </table>
                <h3>Resep Obat (Contoh)</h3>
                <table>
                    <thead>
                        <tr>
                            <th>ID Resep</th>
                            <th>ID Pasien</th>
                            <th>Nama Obat</th>
                            <th>Jumlah</th>
                            <th>Dosis</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>R001</td><td>P001</td><td>Paracetamol</td><td>10</td><td>3x sehari 1 tablet</td></tr>
                        <tr><td>R002</td><td>P002</td><td>Oralit</td><td>5</td><td>Setiap diare 1 sachet</td></tr>
                    </tbody>
                </table>
            </div>

            <div id="laporan" class="section" style="display: none;">
                <h2>Laporan SIMPUS</h2>
                <p>Ringkasan dan analisis data puskesmas.</p>
                <h3>Laporan Kunjungan</h3>
                <ul>
                    <li>Total Kunjungan Rawat Jalan: <span id="laporanRawatJalan">0</span></li>
                    <li>Total Kunjungan Rawat Inap: <span id="laporanRawatInap">0</span></li>
                    <li>Total Kunjungan Rujukan: <span id="laporanRujukan">0</span></li>
                </ul>
            </div>
        </div>
        <div id="loginModal" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 1000;">
            <div style="background: rgb(109, 176, 195); padding: 30px; border-radius: 10px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); text-align: center; width: 300px;">
                <h2>Login SIMPUS</h2>
                <input type="text" placeholder="Username (Email Firebase)" id="loginEmail"><br><br>
                <input type="password" placeholder="Password Firebase" id="loginPassword"><br><br>
                <button onclick="performFirebaseLogin()">Login</button>
                <button onclick="hideLogin()">Batal</button>
                <p id="loginError" style="color: red; margin-top: 10px; display: none;"></p>

                <div class="demo-info">
                    <strong>Akun Demo:</strong>
                    <p>Email: <code>admin@puskesmas.com</code></p>
                    <p>Password: <code>123456</code></p>
                    <p style="font-size: 0.8em; color: #777;">(Akun ini hanya untuk tujuan demo, data yang diinput bisa hilang sewaktu-waktu.)</p>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // Impor modul Firebase yang dibutuhkan
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAW6hUVOpRc-C2AccFLnuOhlmW225XlHig",
            authDomain: "simpusweb-24213.firebaseapp.com",
            projectId: "simpusweb-24213",
            storageBucket: "simpusweb-24213.firebasestorage.app",
            messagingSenderId: "95282612914",
            appId: "1:95282612914:web:82909b432bbb38e61057ab",
            measurementId: "G-BRCCHL8K1J"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app); // Get Firebase Authentication service
        const db = getFirestore(app); // Get Firebase Firestore service

        let pasienData = []; // Ini akan kita isi dari Firestore

        // --- Fungsi untuk Mengatur Tampilan Bagian (Sections) ---
        const sections = document.querySelectorAll('.section');
        const navLinks = document.querySelectorAll('nav ul li a');
        const authLink = document.getElementById('authLink');
        const mainContent = document.getElementById('mainContent');

        function showSection(id) {
            sections.forEach(section => {
                section.style.display = 'none';
            });
            const targetSection = document.getElementById(id);
            if (targetSection) {
                targetSection.style.display = 'block';
            }

            navLinks.forEach(link => {
                link.classList.remove('active');
            });
            const activeLink = document.querySelector(`nav ul li a[href="#${id}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
        }

        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                if (this.getAttribute('href') === '#') {
                    e.preventDefault();
                    return;
                }
                e.preventDefault();
                const sectionId = this.getAttribute('href').substring(1);
                showSection(sectionId);
            });
        });

        // --- Fungsi untuk Render Tabel Pasien dari Firestore ---
        async function fetchAndRenderPasienData() {
            pasienData = [];
            try {
                const querySnapshot = await getDocs(collection(db, "pasien"));
                querySnapshot.forEach((doc) => {
                    pasienData.push({ id: doc.id, ...doc.data() });
                });

                pasienData.sort((a, b) => {
                    const dateA = new Date(a.tanggal);
                    const dateB = new Date(b.tanggal);
                    return dateB - dateA;
                });

                renderPasienTableDashboard();
                renderPasienTablePendaftaran();
                renderRekamMedisTables();
                renderRawatInapTable();
                updateDashboardStats();
            } catch (error) {
                console.error("Error fetching pasien data:", error);
                alert("Gagal memuat data pasien. Pastikan aturan Firestore sudah benar dan Anda memiliki izin. Error: " + error.message);
            }
        }

        function renderPasienTableDashboard() {
            const tabelBody = document.querySelector('#tabelPasien tbody');
            tabelBody.innerHTML = '';
            const latestPatients = pasienData.slice(0, 5);
            latestPatients.forEach(pasien => {
                const row = tabelBody.insertRow();
                row.insertCell().textContent = pasien.id;
                row.insertCell().textContent = pasien.nama;
                row.insertCell().textContent = pasien.jenis ? pasien.jenis.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'N/A';
                row.insertCell().textContent = pasien.tanggal;
            });
        }

        function renderPasienTablePendaftaran() {
            const tabelBody = document.querySelector('#tabelPendaftaranPasien tbody');
            tabelBody.innerHTML = '';
            pasienData.forEach(pasien => {
                const row = tabelBody.insertRow();
                row.insertCell().textContent = pasien.id;
                row.insertCell().textContent = pasien.nama;
                row.insertCell().textContent = pasien.jenis ? pasien.jenis.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'N/A';
                row.insertCell().textContent = pasien.tanggal;
                row.insertCell().textContent = pasien.statusRujukan ? (pasien.statusRujukan === 'dirujuk' ? 'Dirujuk' : 'Tidak Dirujuk') : 'Tidak Dirujuk';
            });
        }

        function renderRekamMedisTables() {
            const tabelRawatJalanBody = document.querySelector('#rekamMedisRawatJalanBody');
            const tabelRujukanBody = document.querySelector('#rekamMedisRujukanBody');
            tabelRawatJalanBody.innerHTML = '';
            tabelRujukanBody.innerHTML = '';

            pasienData.forEach(pasien => {
                if (pasien.jenis === 'rawat_jalan' && pasien.statusRujukan !== 'dirujuk') {
                    const row = tabelRawatJalanBody.insertRow();
                    row.insertCell().textContent = pasien.id;
                    row.insertCell().textContent = pasien.nama;
                    row.insertCell().textContent = pasien.tanggal; // Tanggal Kunjungan
                    row.insertCell().textContent = pasien.diagnosa || 'Belum ada';
                    row.insertCell().textContent = pasien.tindakan || 'Belum ada';
                } else if (pasien.statusRujukan === 'dirujuk') {
                    const row = tabelRujukanBody.insertRow();
                    row.insertCell().textContent = pasien.id;
                    row.insertCell().textContent = pasien.nama;
                    row.insertCell().textContent = pasien.tanggal; // Tanggal Rujukan (dari pendaftaran)
                    row.insertCell().textContent = pasien.alasanRujukan || 'Tidak ada';
                    row.insertCell().textContent = pasien.fasilitasRujukan || 'Tidak ada';
                }
            });
        }

        function renderRawatInapTable() {
            const tabelRawatInapBody = document.querySelector('#rawatInapBody');
            tabelRawatInapBody.innerHTML = '';
            pasienData.forEach(pasien => {
                if (pasien.jenis === 'rawat_inap') {
                    const row = tabelRawatInapBody.insertRow();
                    row.insertCell().textContent = pasien.id;
                    row.insertCell().textContent = pasien.nama;
                    row.insertCell().textContent = pasien.ruangan || 'Belum dialokasikan';
                    row.insertCell().textContent = pasien.bed || 'Belum dialokasikan';
                    row.insertCell().textContent = pasien.tanggal;
                    row.insertCell().textContent = pasien.diagnosa || 'Belum ada';
                }
            });
        }

        function updateDashboardStats() {
            document.getElementById('totalPasien').textContent = pasienData.length;
            const today = new Date().toISOString().slice(0, 10);
            const kunjunganToday = pasienData.filter(p => p.tanggal === today).length;
            document.getElementById('kunjunganHariIni').textContent = kunjunganToday;
            document.getElementById('pasienRawatInap').textContent = pasienData.filter(p => p.jenis === 'rawat_inap').length;
            document.getElementById('pasienRujukan').textContent = pasienData.filter(p => p.statusRujukan === 'dirujuk').length;

            document.getElementById('laporanRawatJalan').textContent = pasienData.filter(p => p.jenis === 'rawat_jalan' && p.statusRujukan !== 'dirujuk').length;
            document.getElementById('laporanRawatInap').textContent = pasienData.filter(p => p.jenis === 'rawat_inap').length;
            document.getElementById('laporanRujukan').textContent = pasienData.filter(p => p.statusRujukan === 'dirujuk').length;
        }

        // --- Handle Form Pendaftaran (dengan penyimpanan ke Firestore) ---
        const formPendaftaran = document.getElementById('formPendaftaran');
        const statusRujukanSelect = document.getElementById('statusRujukan');
        const rujukanDetailFields = document.getElementById('rujukanDetailFields');

        // Toggle visibility of rujukan fields
        statusRujukanSelect.addEventListener('change', function() {
            if (this.value === 'dirujuk') {
                rujukanDetailFields.style.display = 'block';
            } else {
                rujukanDetailFields.style.display = 'none';
                // Clear fields if hidden
                document.getElementById('alasanRujukan').value = '';
                document.getElementById('fasilitasRujukan').value = '';
            }
        });

        formPendaftaran.addEventListener('submit', async function(event) {
            event.preventDefault();
            const nama = document.getElementById('namaPasien').value;
            const tanggalLahir = document.getElementById('tanggalLahir').value;
            const alamat = document.getElementById('alamatPasien').value;
            const jenis = document.getElementById('jenisKunjungan').value;
            const statusRujukan = document.getElementById('statusRujukan').value;
            const newDate = new Date().toISOString().slice(0, 10);

            const pasienDataToSave = {
                nama: nama,
                tanggalLahir: tanggalLahir,
                alamat: alamat,
                jenis: jenis,
                tanggal: newDate,
                statusRujukan: statusRujukan
            };

            // Tambahkan detail rujukan jika statusnya 'dirujuk'
            if (statusRujukan === 'dirujuk') {
                pasienDataToSave.alasanRujukan = document.getElementById('alasanRujukan').value;
                pasienDataToSave.fasilitasRujukan = document.getElementById('fasilitasRujukan').value;
            }

            try {
                const docRef = await addDoc(collection(db, "pasien"), pasienDataToSave);
                console.log("Dokumen ditulis dengan ID: ", docRef.id);
                alert('Pasien ' + nama + ' berhasil didaftarkan sebagai ' + jenis.replace(/_/g, ' ') + (statusRujukan === 'dirujuk' ? ' (Dirujuk)' : '') + '!');
                this.reset();
                statusRujukanSelect.dispatchEvent(new Event('change')); // Reset rujukan fields visibility
                await fetchAndRenderPasienData();
            } catch (e) {
                console.error("Error menambahkan dokumen: ", e);
                alert("Gagal mendaftarkan pasien. Terjadi kesalahan: " + e.message);
            }
        });

        // --- Fungsi untuk Menampilkan/Menyembunyikan Login Modal ---
        window.showLogin = function() {
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('loginError').style.display = 'none';
        }

        window.hideLogin = function() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').textContent = '';
            document.getElementById('loginError').style.display = 'none';
        }

        // --- Fungsi untuk Login dengan Firebase Authentication ---
        window.performFirebaseLogin = async function() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginErrorElement = document.getElementById('loginError');

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                console.log("Login berhasil!", user);
                alert('Login berhasil sebagai ' + user.email + '!');
                hideLogin();
                mainContent.style.display = 'block';
                authLink.textContent = 'Logout';
                authLink.onclick = performLogout;
                await fetchAndRenderPasienData();
                showSection('dashboard');
            } catch (error) {
                const errorCode = error.code;
                const errorMessage = error.message;
                console.error("Error login:", errorCode, errorMessage);
                let displayMessage = "Login gagal. Periksa email dan password Anda.";
                if (errorCode === 'auth/invalid-email') {
                    displayMessage = "Format email tidak valid.";
                } else if (errorCode === 'auth/user-disabled') {
                    displayMessage = "Akun dinonaktifkan.";
                } else if (errorCode === 'auth/user-not-found' || errorCode === 'auth/wrong-password') {
                    displayMessage = "Email atau password salah.";
                }
                loginErrorElement.textContent = displayMessage;
                loginErrorElement.style.display = 'block';
            }
        }

        // --- Fungsi untuk Logout Firebase ---
        window.performLogout = async function() {
            try {
                await signOut(auth);
                alert('Anda telah berhasil logout!');
                mainContent.style.display = 'none';
                showLogin();
                authLink.textContent = 'Login/Logout';
                authLink.onclick = showLogin;
                
                pasienData = [];
                renderPasienTableDashboard();
                renderPasienTablePendaftaran();
                document.querySelector('#rekamMedisRawatJalanBody').innerHTML = '';
                document.querySelector('#rekamMedisRujukanBody').innerHTML = '';
                document.querySelector('#rawatInapBody').innerHTML = '';
                updateDashboardStats();
            } catch (error) {
                console.error("Error logout:", error);
                alert('Gagal logout. Silakan coba lagi.');
            }
        }

        // --- Cek Status Autentikasi Saat Halaman Dimuat ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("User sudah login:", user.email);
                mainContent.style.display = 'block';
                hideLogin();
                authLink.textContent = 'Logout';
                authLink.onclick = performLogout;
                await fetchAndRenderPasienData();
                showSection('dashboard');
            } else {
                console.log("User belum login.");
                mainContent.style.display = 'none';
                showLogin();
                authLink.textContent = 'Login/Logout';
                authLink.onclick = showLogin;
                pasienData = [];
                renderPasienTableDashboard();
                renderPasienTablePendaftaran();
                document.querySelector('#rekamMedisRawatJalanBody').innerHTML = '';
                document.querySelector('#rekamMedisRujukanBody').innerHTML = '';
                document.querySelector('#rawatInapBody').innerHTML = '';
                updateDashboardStats();
            }
        });
    </script>
</body>
</html>
