<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMPUS Sehat & Canggih</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        

        :root {
            --primary-dark: #294060;
            --primary-light: #00BCD4;
            --accent-green: #4CAF50;
            --bg-light: #a8d0ea;
            --card-bg: #FFFFFF;
            --text-color: #333333;
            --border-color: #DDDDDD;
            --shadow-light: rgba(0,0,0,0.08);
            --shadow-medium: rgba(0,0,0,0.15);
        }

        body {
            font-family: 'Lato', sans-serif;
            margin: 0;
            padding: 0; /* Padding akan diatur oleh container */
            background-color: var(--bg-light);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1000px; /* Lebih lebar sedikit */
            margin: 20px auto; /* Margin atas/bawah 20px, auto samping untuk tengah */
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px; /* Lebih membulat */
            box-shadow: 0 6px 12px var(--shadow-light); /* Shadow lebih lembut */
        }

        h1, h2, h3 {
            font-family: 'Poppins', sans-serif;
            color: var(--primary-dark);
            margin-top: 0;
            margin-bottom: 20px;
        }
        h1 {
            text-align: center;
            font-size: 2.5em;
            color: var(--primary-dark);
            margin-bottom: 30px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
        }

        nav ul {
            list-style: none;
            padding: 0;
            display: flex;
            justify-content: center; /* Tengah */
            background-color: var(--primary-dark); /* Biru tua */
            padding: 15px 0;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 4px 8px var(--shadow-light);
            flex-wrap: wrap; /* Untuk responsif jika item terlalu banyak */
        }
        nav ul li {
            margin: 0 15px;
        }
        nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: 600; /* Lebih tebal */
            font-size: 1.1em;
            padding: 8px 12px;
            transition: background-color 0.3s ease, border-radius 0.3s ease;
        }
        nav ul li a:hover {
            background-color: var(--primary-light); /* Biru cerah saat hover */
            border-radius: 5px;
        }
        nav ul li a.active { /* Kelas untuk menandai menu aktif */
            background-color: var(--primary-light);
            border-radius: 5px;
        }

        /* Bagian Section */
        .section {
            padding: 25px;
            margin-bottom: 25px;
            border-radius: 8px;
            background-color: var(--card-bg);
            box-shadow: 0 2px 5px var(--shadow-light);
            transition: transform 0.2s ease;
        }
        .section:hover {
            transform: translateY(-3px); /* Efek sedikit terangkat saat hover */
        }

        /* Dashboard Widgets (Cards) */
        .widget-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* Responsif */
            gap: 20px;
            margin-bottom: 30px;
        }
        .widget {
            background-color: #E6F7FF; /* Warna dasar cerah untuk widget */
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 4px var(--shadow-light);
            border-left: 5px solid var(--primary-light); /* Garis aksen */
            transition: all 0.3s ease;
        }
        .widget:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px var(--shadow-medium);
        }
        .widget h3 {
            color: var(--primary-dark);
            font-size: 1.3em;
            margin-bottom: 10px;
        }
        .widget p {
            font-size: 2.8em;
            font-weight: 700;
            color: var(--primary-light); /* Angka lebih menonjol */
            margin: 0;
        }

        /* Form Styling */
        form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-dark);
        }
        form input[type="text"],
        form input[type="date"], /* Tambahkan jika ada input tanggal */
        form select,
        form textarea { /* Tambahkan jika ada textarea */
            width: calc(100% - 22px); /* Lebar penuh dikurangi padding */
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1em;
            box-sizing: border-box; /* Pastikan padding tidak menambah lebar */
        }
        form input[type="text"]:focus,
        form select:focus,
        form textarea:focus {
            border-color: var(--primary-light);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.2); /* Ring fokus */
        }
        form button[type="submit"] {
            background-color: var(--accent-green); /* Hijau untuk tombol submit */
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        form button[type="submit"]:hover {
            background-color: #43A047; /* Sedikit lebih gelap */
            transform: translateY(-1px);
        }
        form button[type="submit"]:active {
            transform: translateY(0);
        }

        /* Tabel Styling */
        table {
            width: 100%;
            border-collapse: separate; /* Gunakan separate untuk border-radius */
            border-spacing: 0;
            margin-top: 20px;
            border-radius: 8px; /* Border radius untuk tabel */
            overflow: hidden; /* Penting untuk border-radius di tabel */
            box-shadow: 0 2px 4px var(--shadow-light);
        }
        table thead {
            background-color: var(--primary-dark);
            color: white;
        }
        table th,
        table td {
            border: 1px solid var(--border-color);
            padding: 12px 15px;
            text-align: left;
        }
        table th:first-child { border-top-left-radius: 8px; }
        table th:last-child { border-top-right-radius: 8px; }
        table tr:last-child td:first-child { border-bottom-left-radius: 8px; }
        table tr:last-child td:last-child { border-bottom-right-radius: 8px; }

        table tbody tr:nth-child(even) {
            background-color: #F8F8F8; /* Warna baris genap */
        }
        table tbody tr:hover {
            background-color: #E0F7FA; /* Warna cerah saat hover */
            cursor: pointer;
        }

        /* Login Modal */
        #loginModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6); /* Lebih gelap */
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Pastikan di atas elemen lain */
        }
        #loginModal > div {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 8px 16px var(--shadow-medium);
            text-align: center;
            width: 300px;
            animation: fadeInScale 0.4s ease-out; /* Animasi muncul */
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        #loginModal h2 {
            margin-bottom: 25px;
            color: var(--primary-dark);
        }
        #loginModal input[type="text"],
        #loginModal input[type="password"] {
            width: calc(100% - 22px);
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1em;
            box-sizing: border-box;
        }
        #loginModal input[type="text"]:focus,
        #loginModal input[type="password"]:focus {
            border-color: var(--primary-light);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.2);
        }

        #loginModal button {
            background-color: var(--primary-light);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 0 10px;
            font-size: 1em;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        #loginModal button:hover {
            background-color: #008C9D; /* Sedikit lebih gelap dari primary-light */
            transform: translateY(-1px);
        }
        #loginModal button:active {
            transform: translateY(0);
        }
        #loginModal button:last-child {
            background-color: #95A5A6; /* Tombol batal */
        }
        #loginModal button:last-child:hover {
            background-color: #7F8C8D;
        }

        .demo-info {
            background-color: #F0F8FF; /* Warna latar belakang info demo */
            border: 1px solid #ADD8E6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            text-align: left;
            font-size: 0.9em;
            color: #555;
            line-height: 1.4;
        }
        .demo-info strong {
            color: var(--primary-dark);
        }
        .demo-info p {
            margin: 5px 0;
        }


        /* Responsiveness Sederhana */
        @media (max-width: 768px) {
            .container {
                margin: 10px auto;
                padding: 20px;
            }
            nav ul {
                flex-direction: column;
                align-items: center;
            }
            nav ul li {
                margin: 5px 0;
            }
            .widget-grid {
                grid-template-columns: 1fr; /* Satu kolom di layar kecil */
            }
            #loginModal > div {
                width: 90%; /* Lebih lebar di layar kecil */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="mainContent" style="display: none;">
            <h1>SIMPUS MKP 2025</h1>

            <nav>
                <ul>
                    <li><a href="#dashboard" class="active">Dashboard</a></li>
                    <li><a href="#pendaftaran">Pendaftaran</a></li>
                    <li><a href="#rekam-medis">Rekam Medis</a></li>
                    <li><a href="#rawat-inap">Rawat Inap</a></li>
                    <li><a href="#farmasi">Farmasi</a></li>
                    <li><a href="#laporan">Laporan</a></li>
                    <li><a href="#" id="authLink" onclick="showLogin()">Login/Logout</a></li>
                </ul>
            </nav>

            <div id="dashboard" class="section">
                <h2>Dashboard</h2>
                <p>Selamat datang di SIMPUS Anda.</p>
                <h3>Ringkasan Data Puskesmas</h3>
                <div class="widget-grid">
                    <div class="widget">
                        <h3>Total Pasien</h3>
                        <p id="totalPasien">0</p>
                    </div>
                    <div class="widget">
                        <h3>Kunjungan Hari Ini</h3>
                        <p id="kunjunganHariIni">0</p>
                    </div>
                    <div class="widget">
                        <h3>Pasien Rawat Inap</h3>
                        <p id="pasienRawatInap">0</p>
                    </div>
                    <div class="widget">
                        <h3>Pasien Rujukan</h3>
                        <p id="pasienRujukan">0</p>
                    </div>
                </div>
                
                <h3>Pasien Terbaru</h3>
                <table id="tabelPasien">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nama</th>
                            <th>Jenis Kunjungan</th>
                            <th>Tanggal</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>

            <div id="pendaftaran" class="section" style="display: none;">
                <h2>Pendaftaran Pasien Baru</h2>
                <form id="formPendaftaran">
                    <label for="namaPasien">Nama Pasien:</label>
                    <input type="text" id="namaPasien" name="namaPasien" required>

                    <label for="tanggalLahir">Tanggal Lahir:</label>
                    <input type="date" id="tanggalLahir" name="tanggalLahir">

                    <label for="alamatPasien">Alamat:</label>
                    <textarea id="alamatPasien" name="alamatPasien" rows="3"></textarea>

                    <label for="jenisKunjungan">Jenis Kunjungan:</label>
                    <select id="jenisKunjungan" name="jenisKunjungan">
                        <option value="rawat_jalan">Rawat Jalan</option>
                        <option value="rawat_inap">Rawat Inap</option>
                        <option value="rujukan">Rujukan</option>
                    </select>
                    <button type="submit">Daftar Pasien</button>
                </form>

                <h3>Daftar Pasien Terdaftar</h3>
                <table id="tabelPendaftaranPasien"> <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nama</th>
                            <th>Jenis Kunjungan</th>
                            <th>Tanggal</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>

            <div id="rekam-medis" class="section" style="display: none;">
                <h2>Rekam Medis Pasien</h2>
                <p>Kelola riwayat kesehatan, diagnosa, dan tindakan medis.</p>
                <table>
                    <thead>
                        <tr>
                            <th>ID Pasien</th>
                            <th>Diagnosa (ICD-10)</th>
                            <th>Tindakan (ICD-9)</th>
                            <th>Tanggal</th>
                        </tr>
                    </thead>
                    <tbody id="rekamMedisBody">
                        <tr><td>P001</td><td>J00 (Common Cold)</td><td>89.02 (Wawancara Medis)</td><td>2025-06-11</td></tr>
                        <tr><td>P002</td><td>A09 (Diare Akut)</td><td>99.29 (Infus)</td><td>2025-06-10</td></tr>
                        <tr><td>P003</td><td>I10 (Hipertensi Primer)</td><td>89.03 (Pengukuran Tensi)</td><td>2025-06-10</td></tr>
                        <tr><td>P004</td><td>A90 (Demam Dengue)</td><td>99.20 (Pengambilan Sampel Darah)</td><td>2025-06-09</td></tr>
                        <tr><td>P005</td><td>N39.0 (Infeksi Saluran Kemih)</td><td>90.09 (Pemeriksaan Urin Lengkap)</td><td>2025-06-08</td></tr>
                        <tr><td>P006</td><td>J18.9 (Pneumonia)</td><td>93.90 (Terapi Oksigen)</td><td>2025-06-09</td></tr>
                        <tr><td>P007</td><td>A01.0 (Typhoid Fever)</td><td>99.21 (Pemberian Antibiotik Intravena)</td><td>2025-06-08</td></tr>
                        <tr><td>P008</td><td>K35.8 (Apendisitis Akut)</td><td>89.01 (Pemeriksaan Abdomen)</td><td>2025-06-07</td></tr>
                        <tr><td>P009</td><td>S52.5 (Fraktur Tulang Lengan Bawah)</td><td>93.59 (Pemasangan Bidai)</td><td>2025-06-06</td></tr>
                        <tr><td>P010</td><td>I21.9 (Miokard Infark Akut)</td><td>89.52 (Elektrokardiogram)</td><td>2025-06-05</td></tr>
                        <tr><td>P011</td><td>K29.7 (Gastritis)</td><td>89.04 (Auskultasi Abdomen)</td><td>2025-06-04</td></tr>
                        <tr><td>P012</td><td>J06.9 (Infeksi Saluran Pernapasan Akut)</td><td>93.89 (Pemberian Obat Oral)</td><td>2025-06-03</td></tr>
                    </tbody>
                </table>
            </div>

            <div id="rawat-inap" class="section" style="display: none;">
                <h2>Manajemen Rawat Inap</h2>
                <p>Kelola alokasi kamar, status pasien, dan catatan perkembangan.</p>
                <table>
                    <thead>
                        <tr>
                            <th>ID Pasien</th>
                            <th>Nama</th>
                            <th>Ruangan</th>
                            <th>Bed</th>
                            <th>Tanggal Masuk</th>
                            <th>Diagnosa</th>
                        </tr>
                    </thead>
                    <tbody id="rawatInapBody">
                        <tr><td>P002</td><td>Ani Lestari</td><td>Melati</td><td>1A</td><td>2025-06-10</td><td>A09 (Diare Akut)</td></tr>
                        <tr><td>P006</td><td>Bayu Dirgantara</td><td>Cempaka</td><td>2B</td><td>2025-06-09</td><td>J18.9 (Pneumonia)</td></tr>
                        <tr><td>P007</td><td>Clara Devi</td><td>Mawar</td><td>3C</td><td>2025-06-08</td><td>A01.0 (Typhoid Fever)</td></tr>
                        <tr><td>P012</td><td>Indah Sari</td><td>Anggrek</td><td>4D</td><td>2025-06-03</td><td>J06.9 (ISPA)</td></tr>
                    </tbody>
                </table>
            </div>

            <div id="farmasi" class="section" style="display: none;">
                <h2>Manajemen Farmasi (Obat)</h2>
                <p>Kelola stok obat dan resep pasien.</p>
                <h3>Stok Obat</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Nama Obat</th>
                            <th>Stok</th>
                            <th>Satuan</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>Paracetamol 500mg</td><td>250</td><td>Tablet</td></tr>
                        <tr><td>Amoxicillin 250mg</td><td>180</td><td>Kapsul</td></tr>
                        <tr><td>Obat Batuk Sirup</td><td>50</td><td>Botol</td></tr>
                        <tr><td>Larutan Oralit</td><td>100</td><td>Sachet</td></tr>
                    </tbody>
                </table>
                <h3>Resep Obat (Contoh)</h3>
                <table>
                    <thead>
                        <tr>
                            <th>ID Resep</th>
                            <th>ID Pasien</th>
                            <th>Nama Obat</th>
                            <th>Jumlah</th>
                            <th>Dosis</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>R001</td><td>P001</td><td>Paracetamol</td><td>10</td><td>3x sehari 1 tablet</td></tr>
                        <tr><td>R002</td><td>P002</td><td>Oralit</td><td>5</td><td>Setiap diare 1 sachet</td></tr>
                    </tbody>
                </table>
            </div>

            <div id="laporan" class="section" style="display: none;">
                <h2>Laporan SIMPUS</h2>
                <p>Ringkasan dan analisis data puskesmas.</p>
                <h3>Laporan Kunjungan</h3>
                <ul>
                    <li>Total Kunjungan Rawat Jalan: <span id="laporanRawatJalan">0</span></li>
                    <li>Total Kunjungan Rawat Inap: <span id="laporanRawatInap">0</span></li>
                    <li>Total Kunjungan Rujukan: <span id="laporanRujukan">0</span></li>
                </ul>
            </div>
        </div>
        <div id="loginModal" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 1000;">
            <div style="background: rgb(109, 176, 195); padding: 30px; border-radius: 10px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); text-align: center; width: 300px;">
                <h2>Login SIMPUS</h2>
                <input type="text" placeholder="Username (Email Firebase)" id="loginEmail"><br><br>
                <input type="password" placeholder="Password Firebase" id="loginPassword"><br><br>
                <button onclick="performFirebaseLogin()">Login</button>
                <button onclick="hideLogin()">Batal</button>
                <p id="loginError" style="color: red; margin-top: 10px; display: none;"></p>

                <div class="demo-info">
                    <strong>Akun Demo:</strong>
                    <p>Email: <code>admin@puskesmas.com</code></p>
                    <p>Password: <code>123456</code></p>
                    <p style="font-size: 0.8em; color: #777;">(Akun ini hanya untuk tujuan demo, data yang diinput bisa hilang sewaktu-waktu.)</p>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // Impor modul Firebase yang dibutuhkan
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAW6hUVOpRc-C2AccFLnuOhlmW225XlHig",
            authDomain: "simpusweb-24213.firebaseapp.com",
            projectId: "simpusweb-24213",
            storageBucket: "simpusweb-24213.firebasestorage.app",
            messagingSenderId: "95282612914",
            appId: "1:95282612914:web:82909b432bbb38e61057ab",
            measurementId: "G-BRCCHL8K1J"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app); // Get Firebase Authentication service
        const db = getFirestore(app); // Get Firebase Firestore service

        let pasienData = []; // Ini akan kita isi dari Firestore

        // --- Fungsi untuk Mengatur Tampilan Bagian (Sections) ---
        const sections = document.querySelectorAll('.section');
        const navLinks = document.querySelectorAll('nav ul li a');
        const authLink = document.getElementById('authLink'); // Changed to use ID
        const mainContent = document.getElementById('mainContent'); // Get the main content container

        function showSection(id) {
            sections.forEach(section => {
                section.style.display = 'none'; // Sembunyikan semua section
            });
            const targetSection = document.getElementById(id);
            if (targetSection) {
                targetSection.style.display = 'block'; // Tampilkan section yang dipilih
            }

            // Atur kelas 'active' pada navigasi
            navLinks.forEach(link => {
                link.classList.remove('active');
            });
            const activeLink = document.querySelector(`nav ul li a[href="#${id}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
        }

        // Event listener untuk navigasi
        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                if (this.getAttribute('href') === '#') { // If it's the login/logout link, prevent default and handle separately
                    e.preventDefault();
                    return; // Handled by inline onclick or assigned function
                }
                e.preventDefault();
                const sectionId = this.getAttribute('href').substring(1);
                showSection(sectionId);
            });
        });

        // --- Fungsi untuk Render Tabel Pasien dari Firestore ---
        async function fetchAndRenderPasienData() {
            pasienData = []; // Reset data lokal
            try {
                const querySnapshot = await getDocs(collection(db, "pasien"));
                querySnapshot.forEach((doc) => {
                    pasienData.push({ id: doc.id, ...doc.data() });
                });

                // Sort pasienData by date descending for "Pasien Terbaru"
                pasienData.sort((a, b) => {
                    // Ensure dates are valid for comparison
                    const dateA = new Date(a.tanggal);
                    const dateB = new Date(b.tanggal);
                    return dateB - dateA;
                });

                renderPasienTableDashboard();
                renderPasienTablePendaftaran();
                updateDashboardStats();
            } catch (error) {
                console.error("Error fetching pasien data:", error);
                // Optionally display an error message on the dashboard or console
                alert("Gagal memuat data pasien. Pastikan aturan Firestore sudah benar dan Anda memiliki izin. Error: " + error.message);
            }
        }

        function renderPasienTableDashboard() {
            const tabelBody = document.querySelector('#tabelPasien tbody');
            tabelBody.innerHTML = '';
            const latestPatients = pasienData.slice(0, 5); // Ambil 5 terbaru
            latestPatients.forEach(pasien => {
                const row = tabelBody.insertRow();
                row.insertCell().textContent = pasien.id;
                row.insertCell().textContent = pasien.nama;
                row.insertCell().textContent = pasien.jenis ? pasien.jenis.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'N/A'; // Handle undefined 'jenis'
                row.insertCell().textContent = pasien.tanggal;
            });
        }

        function renderPasienTablePendaftaran() {
            const tabelBody = document.querySelector('#tabelPendaftaranPasien tbody');
            tabelBody.innerHTML = '';
            pasienData.forEach(pasien => {
                const row = tabelBody.insertRow();
                row.insertCell().textContent = pasien.id;
                row.insertCell().textContent = pasien.nama;
                row.insertCell().textContent = pasien.jenis ? pasien.jenis.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'N/A';
                row.insertCell().textContent = pasien.tanggal;
            });
        }

        function updateDashboardStats() {
            document.getElementById('totalPasien').textContent = pasienData.length;
            const today = new Date().toISOString().slice(0, 10);
            const kunjunganToday = pasienData.filter(p => p.tanggal === today).length;
            document.getElementById('kunjunganHariIni').textContent = kunjunganToday;
            document.getElementById('pasienRawatInap').textContent = pasienData.filter(p => p.jenis === 'rawat_inap').length;
            document.getElementById('pasienRujukan').textContent = pasienData.filter(p => p.jenis === 'rujukan').length;

            document.getElementById('laporanRawatJalan').textContent = pasienData.filter(p => p.jenis === 'rawat_jalan').length;
            document.getElementById('laporanRawatInap').textContent = pasienData.filter(p => p.jenis === 'rawat_inap').length;
            document.getElementById('laporanRujukan').textContent = pasienData.filter(p => p.jenis === 'rujukan').length;
        }

        // --- Handle Form Pendaftaran (dengan penyimpanan ke Firestore) ---
        document.getElementById('formPendaftaran').addEventListener('submit', async function(event) {
            event.preventDefault();
            const nama = document.getElementById('namaPasien').value;
            const tanggalLahir = document.getElementById('tanggalLahir').value;
            const alamat = document.getElementById('alamatPasien').value;
            const jenis = document.getElementById('jenisKunjungan').value;
            const newDate = new Date().toISOString().slice(0, 10);

            try {
                // Tambahkan dokumen baru ke koleksi "pasien" di Firestore
                const docRef = await addDoc(collection(db, "pasien"), {
                    nama: nama,
                    tanggalLahir: tanggalLahir,
                    alamat: alamat,
                    jenis: jenis,
                    tanggal: newDate // Tanggal pendaftaran
                });
                console.log("Dokumen ditulis dengan ID: ", docRef.id);
                alert('Pasien ' + nama + ' berhasil didaftarkan sebagai ' + jenis.replace(/_/g, ' ') + '!');
                this.reset(); // Reset form
                await fetchAndRenderPasienData(); // Muat ulang data setelah penambahan
            } catch (e) {
                console.error("Error menambahkan dokumen: ", e);
                alert("Gagal mendaftarkan pasien. Terjadi kesalahan: " + e.message);
            }
        });

        // --- Fungsi untuk Menampilkan/Menyembunyikan Login Modal ---
        window.showLogin = function() { // Make it global for inline onclick
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('loginError').style.display = 'none'; // Sembunyikan error sebelumnya
        }

        window.hideLogin = function() { // Make it global for inline onclick
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').textContent = '';
            document.getElementById('loginError').style.display = 'none';
        }

        // --- Fungsi untuk Login dengan Firebase Authentication ---
        window.performFirebaseLogin = async function() { // Make it global for inline onclick
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginErrorElement = document.getElementById('loginError');

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                console.log("Login berhasil!", user);
                alert('Login berhasil sebagai ' + user.email + '!');
                hideLogin();
                // When logged in, display the main content
                mainContent.style.display = 'block'; 
                authLink.textContent = 'Logout'; // Ubah teks link
                authLink.onclick = performLogout; // Ubah fungsi onclick
                await fetchAndRenderPasienData(); // Muat data setelah login
                showSection('dashboard'); // Redirect to dashboard after successful login
            } catch (error) {
                const errorCode = error.code;
                const errorMessage = error.message;
                console.error("Error login:", errorCode, errorMessage);
                let displayMessage = "Login gagal. Periksa email dan password Anda.";
                if (errorCode === 'auth/invalid-email') {
                    displayMessage = "Format email tidak valid.";
                } else if (errorCode === 'auth/user-disabled') {
                    displayMessage = "Akun dinonaktifkan.";
                } else if (errorCode === 'auth/user-not-found' || errorCode === 'auth/wrong-password') {
                    displayMessage = "Email atau password salah.";
                }
                loginErrorElement.textContent = displayMessage;
                loginErrorElement.style.display = 'block';
            }
        }

        // --- Fungsi untuk Logout Firebase ---
        window.performLogout = async function() { // Make it global for inline onclick
            try {
                await signOut(auth);
                alert('Anda telah berhasil logout!');
                // When logged out, hide the main content and show login modal
                mainContent.style.display = 'none'; 
                showLogin(); 
                authLink.textContent = 'Login/Logout'; // Kembalikan teks link
                authLink.onclick = showLogin; // Kembalikan fungsi onclick
                
                pasienData = []; // Hapus data pasien lokal setelah logout
                renderPasienTableDashboard(); // Kosongkan tabel
                renderPasienTablePendaftaran(); // Kosongkan tabel
                updateDashboardStats(); // Reset statistik
            } catch (error) {
                console.error("Error logout:", error);
                alert('Gagal logout. Silakan coba lagi.');
            }
        }

        // --- Cek Status Autentikasi Saat Halaman Dimuat ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("User sudah login:", user.email);
                mainContent.style.display = 'block'; // Tampilkan konten utama
                hideLogin(); // Pastikan modal login tersembunyi
                authLink.textContent = 'Logout';
                authLink.onclick = performLogout;
                await fetchAndRenderPasienData(); // Muat data pasien
                showSection('dashboard'); // Tampilkan dashboard setelah login
            } else {
                console.log("User belum login.");
                mainContent.style.display = 'none'; // Sembunyikan konten utama
                showLogin(); // Otomatis tampilkan modal login
                authLink.textContent = 'Login/Logout';
                authLink.onclick = showLogin;
                pasienData = []; // Kosongkan data pasien lokal
                renderPasienTableDashboard(); // Kosongkan tabel
                renderPasienTablePendaftaran(); // Kosongkan tabel
                updateDashboardStats(); // Reset statistik
                // showSection('dashboard') is not needed here as mainContent is hidden
            }
        });
    </script>
</body>
</html>
